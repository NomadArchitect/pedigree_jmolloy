####################################
# SCons build system for Pedigree
## Tyler Kennedy (AKA Linuxhq AKA TkTech)
####################################

import os.path
Import(['env'])

# Common drivers - order is important
driver_common_subdirs = [
    # DMA
    'dma',

    # Pedigree-specific disk I/O
    'ata',
    'partition',

    # Pedigree-specific video
    'nvidia',

    # Pedigree-specific NICs
    '3c90x',
    'rtl8139',
    'loopback',

    # Pedigree-specific USB drivers
    'uhci',

    # CDI framwork
    'cdi',

    # CDI NIC drivers
    'e1000',
    'pcnet',
    'sis900',

    # CDI Disk drivers
    # 'floppy' # Needs millisecond granularity in cdi_sleep_ms...
]

# Architecture-specific drivers
if env['ARCH_TARGET'] == 'X86' or env['ARCH_TARGET'] == 'X64':
    driver_arch = 'x86'
    driver_arch_subdirs = [
        'pci',
        'ne2k',
        'vbe'
    ]
elif env['ARCH_TARGET'] == 'PPC':
    driver_arch = 'ppc'
    driver_arch_subdirs = [
        'ata-specific',
        'framebuffer',
        'test'
    ]

# Modules - order is important
module_subdirs = [
    'vfs',
    'ext2',
    'fat',
    'iso9660',
    'network',
    'dhcpclient',
    'console',
    'TUI',
    'linker',
    'users',
    'ramfs',
    'rawfs',
    'lodisk',
    'usb',
    'splash'
]

if env['installer']:
    module_subdirs += ['installer']
else:
    module_subdirs += ['init']

drivers = ['drivers/' + driver_arch + '/' + i for i in driver_arch_subdirs]
drivers += ['drivers/common/' + i for i in driver_common_subdirs]
modules = ['system/' + i for i in module_subdirs]

SConscript([os.path.join(i, 'SConscript') for i in drivers],exports = ['env'])
SConscript([os.path.join(i, 'SConscript') for i in modules],exports = ['env'])

# Ready to generate the initrd...
builddir = env.Dir("#" + env["PEDIGREE_BUILD_BASE"])
initrdFile = env.File("#" + env["PEDIGREE_BUILD_BASE"] + "/initrd.tar")

# initrd lists

# JamesM: Put VBE driver first, then Splash
initrdList = []
if "pci" in driver_arch_subdirs:
    initrdList += [builddir.abspath + '/drivers/pci.o']
    driver_arch_subdirs.remove("pci")
if "vbe" in driver_arch_subdirs:
    initrdList += [builddir.abspath + '/drivers/vbe.o']
    driver_arch_subdirs.remove("vbe")
if "splash" in module_subdirs:
    initrdList += [builddir.abspath + '/modules/splash.o']
    module_subdirs.remove("splash")

initrdList += [builddir.abspath + '/drivers/' + i + '.o' for i in driver_arch_subdirs]
initrdList += [builddir.abspath + '/drivers/' + i + '.o' for i in driver_common_subdirs]
initrdList += [builddir.abspath + '/modules/' + i + '.o' for i in module_subdirs]

# Subsystems
initrdList += [builddir.abspath + '/subsystems/posix.o']

initrd = ' '.join(initrdList)
# BUG: "posix.o" is added to the initrd twice: could this be the cause?
initrd += ' ' + builddir.abspath + '/subsystems/*'

env.Depends(initrdFile, "drivers")
env.Depends(initrdFile, "modules")
env.Depends(initrdFile, "subsys")
env.Alias("initrd", initrdFile)
env.Command(initrdFile, None, '@echo Building initrd... && tar --absolute-names --transform="s,/.*/,," -czf $TARGET ' + initrd)
